# 📊 積み立て投資マイルール確認アプリ

VIX指数と為替レート（USD/JPY）または日経VIを基準に、投資ルールを管理するPWA（Progressive Web App）アプリケーションです。

## ✨ 主な機能

### 実装済み機能

1. **マーケット指標の自動取得**
   - VIX指数（恐怖指数）の取得
   - USD/JPY為替レート（米国株向け）
   - 日経VI（日本株向け）
   - リアルタイムデータの自動更新

2. **カスタマイズ可能な投資マトリクス**
   - 最大5×5のマトリクス設定
   - VIX範囲と為替/VI範囲の自由設定
   - 各セルに投資ルール（金額など）を設定可能

3. **推奨ルールの自動表示**
   - 現在の市場状況に基づいて該当するルールを自動表示
   - シンプルで見やすいUIデザイン
   - 2行レイアウト：
     - 1行目：VIX指数 + USD/JPY（各32px）
     - 2行目：推奨ルール（64px - 大きく表示）

4. **データ永続化**
   - localStorage による設定保存
   - オフライン対応（Service Worker）
   - PWA対応（iOS/Androidホーム画面追加可能）

5. **セキュアなAPI管理**
   - ユーザー個別のAPIキー入力システム
   - localStorageによる安全な保存
   - ソースコードにAPIキーを含まない設計

6. **CORS問題の解決**
   - 複数のCORSプロキシを自動試行
   - AllOrigins、CORSProxy.io対応
   - フォールバック機構による高可用性

7. **範囲境界の正確な処理**
   - 小数点を含む値の正確な範囲判定
   - .99小数点終了による範囲ギャップの解消
   - 例：154.08円が「中立（141-154.99円）」に正しく分類

8. **設定画面からの値保持**
   - 設定変更時も既存のマトリクス値を保持
   - 範囲の追加/削除に対応
   - データ損失の防止

## 📱 使い方

### 初回起動時

1. アプリが自動的にメイン画面を表示
2. **初期設定（デフォルト値）**で現在の指標と推奨ルールを表示
   - VIX 5段階 × USD/JPY 3段階のマトリクス
   - すぐに使える投資ルールのサンプル値
3. データは自動的に取得されます

**重要**: 初期設定は**あくまでサンプル**です。必ず設定ボタン（⚙️）から自分の投資スタイルに合わせてカスタマイズしてください。

### 設定変更

#### 初回設定フロー
1. **市場選択**: 米国株のみ/日本株のみ/両方から選択
2. **VIX範囲設定**: 縦軸（最大5段階）の範囲を設定
3. **為替/VI範囲設定**: 横軸（最大5段階）の範囲を設定
4. **APIキー設定**: オプションで自動データ取得用のAPIキーを設定
5. **「設定を保存してマトリクスへ」をクリック**
6. **マトリクス値入力画面**: 各セルに投資ルールを入力（例: 通常\n月5万円）
7. **「完了」ボタン**: 保存してメイン画面に戻る

#### 設定の変更（⚙️ボタンから）
1. メイン画面右上の ⚙️ ボタンをクリック
2. 設定画面で範囲やAPIキーを変更可能
3. 変更後は同じフロー（設定保存 → マトリクス値入力 → 完了）

### データ更新

- 「データ更新」ボタンをクリックで手動更新
- 自動更新は起動時とナビゲーション時に実行

## 🔗 機能エントリポイント

### メイン画面（マトリクス表示画面）
- **URI**: `index.html` → `#matrixScreen`
- **表示内容**:
  - VIX指数（リアルタイム）
  - USD/JPY為替レート（米国株）または日経VI（日本株）
  - 現在の推奨ルール（マトリクスから自動算出）- 大きく表示
- **アクション**:
  - データ更新ボタン: 最新の市場データを取得
  - 設定ボタン（⚙️）: 設定画面へ遷移

### 設定画面（初期設定画面）
- **URI**: `#setupScreen`
- **表示内容**:
  - 市場選択（米国株のみ/日本株のみ/両方）
  - 米国株マトリクス設定
    - VIX範囲設定（縦軸）- 最大5段階
    - 為替（USD/JPY）範囲設定（横軸）- 最大5段階
  - 日本株マトリクス設定
    - VIX範囲設定（縦軸）- 最大5段階
    - 日経VI範囲設定（横軸）- 最大5段階
  - APIキー管理
    - Twelve Data APIキー
    - Finnhub APIキー
    - Alpha Vantage APIキー
- **アクション**:
  - 範囲の追加・削除ボタン
  - APIキー設定・変更ボタン
  - 「設定を保存してマトリクスへ」ボタン: マトリクス値入力画面へ遷移

### マトリクス値入力画面
- **URI**: `#matrixValueScreen`
- **表示内容**:
  - 米国株マトリクス値の設定（市場が米国株または両方の場合）
  - 日本株マトリクス値の設定（市場が日本株または両方の場合）
  - マトリクステーブル（VIX×為替/VIのグリッド）
- **機能**:
  - 各セルに投資ルール入力（テキストエリア）
  - 改行対応（例: 通常\n月5万円）
- **アクション**:
  - 「完了」ボタン: 設定を保存してメイン画面へ遷移

## 🛠️ 技術スタック

- **フロントエンド**: HTML5, CSS3, Vanilla JavaScript
- **データ取得**:
  - Twelve Data API（VIX、USD/JPY）
  - Yahoo Finance API（CORSプロキシ経由）
  - ExchangeRate API（USD/JPY）
  - Finnhub API（オプション）
  - Alpha Vantage API（オプション）
- **データ永続化**: localStorage API
  - ユーザーの設定（市場選択、範囲設定、マトリクス値）
  - APIキー（ユーザー個別）
  - 最新の市場データ（キャッシュ）
- **PWA**: Service Worker, Web App Manifest
- **デザイン**: CSS Grid, Flexbox, Google Fonts (Noto Sans JP)

## 📊 データモデル

### Config Structure
```javascript
{
  market: 'us' | 'jp' | 'both',
  us: {
    vixRanges: [
      { min: number, max: number, label: string }
    ],
    forexRanges: [
      { min: number, max: number, label: string }
    ],
    matrixValues: [
      ['値1', '値2', ...],
      ...
    ]
  },
  jp: {
    vixRanges: [...],
    nikkeiviRanges: [...],
    matrixValues: [...]
  }
}
```

### Data Structure
```javascript
{
  vix: number,           // VIX指数
  usdjpy: number,        // USD/JPY為替レート
  nikkeiVi: number,      // 日経VI
  timestamp: number      // データ取得時刻
}
```

### API Keys Structure
```javascript
{
  TWELVE_DATA: string,    // Twelve Data API Key
  FINNHUB: string,        // Finnhub API Key
  ALPHA_VANTAGE: string   // Alpha Vantage API Key
}
```

## 🔐 セキュリティ

- **APIキー管理**: ユーザー個別にlocalStorageに保存
- **ソースコード**: APIキーを含まない設計
- **GitHub公開**: 安全にソースコードを公開可能
- **CORS対策**: 複数のプロキシサーバーによるフォールバック

## 📝 初期設定（デフォルト値）

**注意**: 以下の設定は**初回起動時のみ**使用される初期値です。ユーザーが設定を変更すると、その変更内容が保存され、以降は個別の設定が使用されます。

### VIX範囲（縦軸）- 初期値
1. VIX 12以下（0-12.99）
2. VIX 13-19（13-19.99）
3. VIX 20-29（20-29.99）
4. VIX 30-39（30-39.99）
5. VIX 40+（40-999）

### USD/JPY範囲（横軸）- 初期値
1. 円高（140円以下：0-140.99）
2. 中立（141-154円：141-154.99）
3. 円安（155円以上：155-999）

### マトリクス値（米国株）- 初期値
```
             円高        中立        円安
VIX 12以下   通常5万     減額4万     減額3万
VIX 13-19    増額6万     通常5万     減額4万
VIX 20-29    増額7万     増額6万     通常5万
VIX 30-39    大幅12万    増額8万     増額6万
VIX 40+      最強15万    大幅12万    増額10万
```

**設定のカスタマイズ**:
- 初回起動後、設定ボタン（⚙️）から自由にカスタマイズ可能
- 変更した設定は localStorage に保存され、次回起動時も保持されます
- 設定をリセットしたい場合は、ブラウザの開発者ツールで localStorage をクリアしてください

## 💾 データ管理

### ユーザーデータの保存場所

すべてのデータは**ブラウザのlocalStorage**に保存されます：

1. **設定データ** (`investmentRulesConfig`)
   - 市場選択（米国株/日本株/両方）
   - VIX範囲設定
   - 為替/日経VI範囲設定
   - マトリクス値（投資ルール）

2. **APIキー** (`investmentRulesApiKeys`)
   - Twelve Data APIキー
   - Finnhub APIキー
   - Alpha Vantage APIキー

3. **市場データ** (`investmentRulesData`)
   - 最新のVIX指数
   - 最新のUSD/JPY為替レート
   - 最新の日経VI
   - データ取得時刻

### データの特性

- **ブラウザ固有**: データはブラウザごとに独立して保存されます
  - Chrome と Safari では別々
  - プライベートモードでは保存されません
- **デバイス固有**: データはデバイスごとに独立しています
  - PC とスマホでは別々
  - 自動同期機能はありません
- **永続的**: ブラウザのキャッシュをクリアしない限り保持されます

### 設定のリセット方法

初期設定に戻したい場合：

#### 方法1: ブラウザの開発者ツール
1. `F12` キーを押して開発者ツールを開く
2. 「Application」タブ（または「ストレージ」）を選択
3. 左側の「Local Storage」→ サイトのURL を選択
4. `investmentRulesConfig` を削除
5. ページをリロード

#### 方法2: コンソールコマンド
1. `F12` キーを押してコンソールを開く
2. 以下のコマンドを実行：
```javascript
localStorage.clear();
location.reload();
```

### データのバックアップ

現在の設定をバックアップしたい場合：

```javascript
// コンソールで実行
const config = localStorage.getItem('investmentRulesConfig');
console.log(config); // この内容をコピーして保存
```

復元する場合：
```javascript
// コンソールで実行（保存した内容を貼り付け）
localStorage.setItem('investmentRulesConfig', '保存した内容');
location.reload();
```

## 🚀 デプロイ方法

### GitHub Pages
1. GitHubリポジトリにプッシュ
2. Settings → Pages → Source: main branch
3. 公開URLからアクセス

### PWAインストール（iOS）
1. Safariでアプリを開く
2. 共有ボタンをタップ
3. 「ホーム画面に追加」を選択
4. アイコンからアプリ起動

## 📋 今後の実装予定

1. **データ取得の改善**
   - より多くのデータソースの追加
   - APIキー不要のデータソース優先
   - データキャッシュ機能

2. **UI/UX改善**
   - ダークモード対応
   - アニメーション追加
   - 横画面レイアウト最適化

3. **データ分析機能**
   - 履歴データの保存
   - グラフ表示
   - 統計情報の提供

4. **通知機能**
   - 指定条件での通知
   - Web Push API対応
   - カスタムアラート設定

5. **エクスポート機能**
   - 設定のエクスポート/インポート
   - データのCSV出力
   - バックアップ機能

## ✅ 修正履歴

### v1.0.1 (2025-11-02)
- **UI改善**: マトリクス値入力画面を独立した専用画面として実装
- **バグ修正**: 設定画面を再度開いた時にVIX/為替範囲が表示されない問題を修正
- **バグ修正**: 「完了」ボタンが「APIキー管理」セクション内に表示される問題を修正
- **機能改善**: 設定画面（setupScreen）のHTML構造を動的に再構築し、状態管理を改善

### v1.0.0 (2025-11-02)
- 初回リリース
- VIX指数とUSD/JPY為替レートに基づく投資ルール管理機能
- カスタマイズ可能な投資マトリクス（最大5×5）
- PWA対応（iOS/Androidホーム画面追加可能）
- APIキーのユーザー管理システム
- CORS問題の解決（複数プロキシによるフォールバック）

## 🐛 既知の問題

1. **CORS制限**
   - 一部のCORSプロキシが不安定な場合がある
   - 複数のプロキシでフォールバック実装済み

2. **APIレート制限**
   - 無料APIプランには取得回数制限あり
   - 頻繁な更新は避けてください

3. **デバッグログ**
   - 現在、開発用の詳細なコンソールログが有効
   - 本番環境では無効化を推奨
   
4. **マトリクス値が空になる問題**
   - 設定画面からマトリクス値入力画面に遷移した時に、以前の値が表示されない場合がある
   - **確認方法**: ブラウザのコンソール（F12）を開いて、以下のログを確認してください
     - `💾 保存前の米国株マトリクス値`: 既存の値が表示されているか
     - `🔄 initMatrixValues`: defaults パラメータに既存の値が渡されているか
     - `📊 generateInputTable`: matrixValues に値が存在するか
   - 問題が発生した場合は、コンソールログのスクリーンショットを添付してご報告ください

## 📄 ライセンス

このプロジェクトは個人利用向けに作成されています。

## 🤝 貢献

バグ報告や機能提案はIssueでお願いします。

## ❓ よくある質問（FAQ）

### Q1: デフォルト設定は誰でも同じですか？

**A**: はい、**初回起動時のみ**、すべてのユーザーに同じ初期設定が表示されます。しかし、設定を一度でも変更すると、その変更内容が保存され、以降は個別の設定が使用されます。

**初期設定はサンプル**なので、必ず自分の投資スタイルに合わせてカスタマイズしてください。

### Q2: 設定は他のデバイスと同期されますか？

**A**: いいえ、設定は**ブラウザのlocalStorage**に保存されるため、デバイスやブラウザごとに独立しています。

- PC と スマホでは別々
- Chrome と Safari では別々
- 同期機能はありません

各デバイスで個別に設定する必要があります。

### Q3: マトリクス値が消えてしまいました

**A**: 以下の原因が考えられます：

1. **ブラウザのキャッシュをクリアした**: localStorage が削除されると設定も失われます
2. **プライベートモードで使用**: プライベートモードでは設定が保存されません
3. **範囲のサイズを変更した**: VIX/為替の段階数を変更すると、一部の値が失われます（仕様）

**対策**: 
- 設定をバックアップする（上記「データ管理」セクション参照）
- 範囲を変更する前にマトリクス値をメモする

### Q4: APIキーは必須ですか？

**A**: いいえ、**APIキーなしでも使用できます**。

- APIキーなし: 手動でデータを入力
- APIキーあり: 自動的にデータを取得

Twelve Data の無料APIキーを取得すると、自動データ取得が利用できます（1日800リクエストまで無料）。

### Q5: データはどのくらいの頻度で更新されますか？

**A**: データ更新は以下のタイミングで実行されます：

- アプリ起動時（自動）
- 「データ更新」ボタンをクリックした時（手動）
- 設定完了後（自動）

**注意**: 無料APIプランには取得回数制限があるため、頻繁な更新は避けてください。

### Q6: 複数の投資ルールを管理できますか？

**A**: 現在のバージョンでは、**1つの設定のみ**を保存できます。

複数の投資ルールを管理したい場合：
- 異なるブラウザを使用する
- ブラウザのプロファイル機能を使用する
- 設定をバックアップして切り替える

将来のバージョンで複数設定のサポートを検討しています。

### Q7: オフラインで使用できますか？

**A**: はい、**PWA（Progressive Web App）**として動作するため、オフラインでも使用できます。

ただし、以下の制限があります：
- 最新の市場データは取得できません（キャッシュされた古いデータを使用）
- APIを使った自動データ取得は動作しません

## 📞 サポート

質問や問題がある場合は、GitHubのIssueまたはDiscussionsでお知らせください。

---

**最終更新**: 2025年11月2日
**バージョン**: 1.0.2
